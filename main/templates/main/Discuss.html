{% extends "global/Page.html" %}
{% load staticfiles otree %}

{% block title %}
    {% block practice %}{% endblock %}Round {{subsession.round_number}}: Messaging Part
{% endblock %}


{% block content %}

{% include "main/instructions_modal.html" %}
{% include "main/quiz_modal.html" %}

{% block beginModal %}
{% comment %}
{% if subsession.round_number == 1 %}
<div class="modal fade" id="startModal">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title">Coordination Game</h4>
      </div>
      <div class="modal-body">
        <p>
            You are now playing the coordination game. Click the button to continue.
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-dismiss="modal">Begin Playing</button>
      </div>
    </div>
  </div>
</div>
<script type="text/javascript" >
$(window).on('load',function(){
        $('#startModal').modal('show');
    });
</script>
{% endif %}
{% endcomment %}
{% endblock %}

<div class="container-fluid" style="position: relative;">
    <div id="cover" style="position: absolute; visibility: hidden; z-index: 100; background-color: #ffffff; pointer-events: none; opacity: .4; height: 100%; left: -20px; right: -20px;">
    </div>
    <div class="row main" style="border-bottom: 1px solid gray; padding-bottom: 10px;">
        
        <div class="col-sm-2 col-lg-2" style="min-width: 160px; max-width: 260px; padding:5px;">
        <div id="playerDiv" class="clicktrack">        
        <h4 style="text-align: left; padding-left: 0px;">Your Profile:</h4>
            <div id="playerLabel" class="linking-button" style="height: 170px; border: 1px #ddd solid; border-radius: 4px; max-width: 170px">
                <br>
	        	   <img src={% block avatar %}{% static "avatar/"|add:avatar %}{% endblock %} alt="Error: No Avatar Available" style="display: block; border-bottom: black 1px solid; margin: auto; width:90px">
                   <p style="text-align: left; font-size: 13pt; margin: 0; margin-top: 5px; margin-left: 15px;">{% block userName %}{{player.user_name}}{% endblock %} (You)</p>	        	   
	        	   <p style="text-align: left; font-size: 9pt; margin: 0; margin-top: 0px; margin-left: 15px;"><strong>Your Threshold: {% block threshold %}{{player.node.threshold_text}}{% endblock %}</strong> </p>
      	    </div>
      	 </div>
      	 <div id="friendsDiv">
      	    <h4>Your Friends:</h4>
            <div id="playerList" class="clearfix" ></div>
         </div>        
        </div>

        <div class="col-sm-6 col-lg-6" style="padding: 5px;">

        <ul id="main-tabs" class="nav nav-tabs" role="tablist">
        {% with 'wall both' as list %}
            {% if session.config.condition_messaging in list.split %}
  		    <li class="nav-item active">
    			<a id="wall_post_nav" class="nav-link active clicktrack" data-toggle="tab" href="#wall" role="tab">Wall Posts</a>
  			</li>
  			{% endif %}
  		{% endwith %}
  		{% if session.config.condition_messaging == 'bilateral' %}
  			<li class="nav-item active">
    			<a id="bilateral_post_nav" class="nav-link clicktrack" data-toggle="tab" href="#messenger" role="tab">Private Messages</a>
  			</li>
		{% endif %}
		{% if session.config.condition_messaging == 'both' %}
  			<li class="nav-item">
    			<a id="bilateral_post_nav" class="nav-link clicktrack" data-toggle="tab" href="#messenger" role="tab">Private Messages</a>
  			</li>
		{% endif %}
		</ul>

		<!-- Tab panes -->
        <div class="tab-content"  style="position: relative; margin-top: 0px; min-height: 475px; padding: 10px; border-right: 1px solid #ddd; border-left: 1px solid #ddd; background-color: #fff;">
        {% with 'wall both' as list %}
            {% if session.config.condition_messaging in list.split %}
                
                <div class="tab-pane active" id="wall" role="tabpanel">
                
                {% block messageTool %}
                <div id="message-tool" class="card message-tool">
                    <div class="card-body">
                        <h4 class="card-title">Wall Messaging Tool</h4>
                        <h6 class="card-subtitle mb-2 text-muted">Post messages to your wall or your friends' walls.</h6>
                        <div class="message-tool-content"></div>
                    </div>
                    <div id="selector-alert" class="alert alert-warning alert-dismissible" style="display: none; font-size: 8pt; margin-bottom:0; padding-top: 5px; padding-bottom: 5px;" role="alert">
                        <strong>Message not sent!</strong> Make sure both fields are selected.
                        <button type="button" class="close" onclick="$('#selector-alert').hide()" aria-label="Close">
                             <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                </div>
                {% endblock %}
                <div id="wall-card" class="card wall-card">
                    <div id="wall-card-body" class="card-body">
                    </div>
                </div>              
                </div>
          	{% endif %}
  		{% endwith %}
  		{% if session.config.condition_messaging == 'bilateral' %}
      		<div class="tab-pane active" id="messenger" role="tabpanel"></div>
        {% endif %}
  		{% if session.config.condition_messaging == 'both' %}
      		<div class="tab-pane" id="messenger" role="tabpanel"></div>
        {% endif %}
		</div>
        </div>
        
        <div class="col-sm-4 col-lg-4" style="padding:5px;">
            {% include "main/network.html" %}
        </div>
    </div>
</div>

<br>

{% block participate %}
{% endblock %}

{% block checkSubmission %}
<p>Click <strong>Next</strong> to continue.</p>
<br>
<div class="modal fade" id="stopModal">
  <div class="modal-dialog" role="document">
    <div class="modal-content" id="stopModal-content">
      <div class="modal-header">
        <h4 class="modal-title">Are you sure?</h4>
      </div>
      <div class="modal-body">
        <div class="card" style="border: 0px;">
    <div class="card-body">
        <h4 class="card-title">Your Post Summary</h4>
        <h6 class="card-subtitle mb-2 text-muted">
            This is a summary of your posts for this round.
            A check appears if one or more posts were sent by you to the player shown.
            Click 'Continue' to continue to the decision page or 'Edit' to make changes to your posts.
        </h6>
    <div id="resultTable"></div>
    </div>
</div>
      </div>
      <div class="modal-footer">
        <button id="btn-discuss-continue" class="otree-btn-next btn btn-primary next-button otree-next-button clicktrack">Continue</button>
        <button id="btn-discuss-edit" type="button" class="btn btn-primary clicktrack" data-dismiss="modal">Edit</button>
      </div>
    </div>
  </div>
</div>

<div class="buttons">
    <p id="stopButton"> 
    <button id="btn-discuss-next" type="button" class="btn btn-primary clicktrack" onclick="resultTable.getInfo();$('#stopModal').modal('show')">Next</button>
    </p>
</div>
{% endblock %}


{% endblock %}

{% block scripts %}

    {% block pageScripts %}
        <script type="text/javascript" >
            var output = true;
        </script>
    {% endblock %}

<script type="text/javascript">
// Load Variables from View.
var messageList = [];
{% for mId, mValue in messages.items %}
	messageList.push('{{mValue}}');
{% endfor %}

var messageRound = {{messageRound}};
var nMessagingRound = {{Constants.num_messaging_rounds}};
var playerId = {{player.id}};
var nodeId = {{player.node.id}};
var neighbor_net = {{neighbor_net|safe}};
var neighbors = {{neighbors|safe}};
var thresholds = {{thresholds|safe}};
var userNames = {{user_names|safe}};
var avatars = {{avatars|safe}};
var entries = JSON.parse('{{wall|safe}}');
var privateEntries = JSON.parse('{{privateMessages|safe}}');
var network_nodes = JSON.parse('{{nodes|escapejs}}');
var network_edges = JSON.parse('{{edges|safe}}');
var chat_name = '{{Constants.chat_name}}';
var network_display = '{{networkDisplay|safe}}';
</script>

<script type="text/javascript" src={% static "global/hash.js" %}></script>
<script type="text/javascript" src={% static "global/jquery-ui.min.js" %}></script>
<script type="text/javascript" src={% static "global/player_list.js" %}></script>


        {% with 'wall both' as list %}
            {% if session.config.condition_messaging in list.split %}
                <script type="text/javascript" src={% static "global/wall-separate.js" %}></script>
          	{% endif %}
  		{% endwith %}
  		{% with 'bilateral both' as list %}
  		{% if session.config.condition_messaging in list.split %}
      		    <script type="text/javascript" src={% static "global/messenger.js" %}></script>
        {% endif %}
        {% endwith %}


<script type="text/javascript" src={% static "global/vis.min.js" %}></script>
<script type="text/javascript" src={% static "global/chat_channels.js" %}></script>
<script type="text/javascript" src={% static "global/intro.min.js" %}></script>


<script type="text/javascript" src={% static "main/network.js" %}></script>
<script type="text/javascript" src={% static "main/page-header-nav.js" %}></script>

    {% if session.config.condition_messaging == 'bilateral'%}
    {% if session.config.condition_network_knowledge == 'global'%}
        <script type="text/javascript" src={% static "main/tutorial-bilateral-global.js" %}></script>
    {% endif %}
    {% if session.config.condition_network_knowledge == 'local'%}
        <script type="text/javascript" src={% static "main/tutorial-bilateral-local.js" %}></script>
    {% endif %}
{% endif %}

{% if session.config.condition_messaging == 'wall'%}
    {% if session.config.condition_network_knowledge == 'global'%}
        <script type="text/javascript" src={% static "main/tutorial-wall-global.js" %}></script>
    {% endif %}
    {% if session.config.condition_network_knowledge == 'local'%}
        <script type="text/javascript" src={% static "main/tutorial-wall-local.js" %}></script>
    {% endif %}
{% endif %}
 
{% comment %}    
{% if session.config.condition_messaging == 'none'%}
    {% if session.config.condition_network_knowledge == 'global'%}
        <script type="text/javascript" src={% static "tour/tutorial.js" %}></script>
    {% endif %}
    {% if session.config.condition_network_knowledge == 'local'%}
        <script type="text/javascript" src={% static "tour/tutorial.js" %}></script>
    {% endif %}
{% endif %}
{% endcomment %}

<script type="text/javascript" >
  var playerProfile = document.getElementById('playerLabel');
  playerProfile.onclick = function() {
    chat.setActiveChannel(nodeId);
	wall.changeId(nodeId);
	chat.infoChannel.send(JSON.stringify({
	  'type': 'list',
	  'content': {'playerId': nodeId, 'sentBy': nodeId},				
	}));
  }
  

{% with 'wall none' as list %}
    {% if session.config.condition_messaging in list.split %}    
        $('.message-icon').hide();
    {% endif %}
{% endwith %}

{% with 'bilateral none' as list %}
    {% if session.config.condition_messaging in list.split %}    
        $('.linking-button').off("click");
        $('.linking-button').each(function () {
            this.onclick = undefined;
            });
    {% endif %}
{% endwith %}

$('[data-toggle="tooltip"]').tooltip({
    trigger: 'hover'
});

</script>
<script type="text/javascript" src={% static "main/resultTable.js" %}></script>
{% endblock %}

{% block styles %}
<link rel="stylesheet" href={% static "global/jquery-ui.min.css" %}>
<link rel="stylesheet" href={% static "global/wall-separate.css" %}>
<link rel="stylesheet" href={% static "global/messenger.css" %}>
<link rel="stylesheet" href={% static "global/player_list.css" %}>
<link rel="stylesheet" href={% static "global/vis.min.css" %}>
<link rel="stylesheet" href={% static "global/introjs.min.css" %}>
<link rel="stylesheet" href={% static "global/open-iconic-master/font/css/open-iconic-bootstrap.css" %}>
<link rel="stylesheet" href={% static "main/tutorial.css" %}>



<style type="text/css">
    h4, h5 {
        margin-top: 10px;
    }

    .close {
        opacity: .34;
        line-height: 1;  
    }

    .clearfix:after {content: "."; display: block; height: 0; clear: both; visibility: hidden;}
    
    .media > .float-left {
        margin-right: 10px;
        min-width: 0px;
    }

    .nav-tabs .no-hover a:hover {
        background-color: transparent;
        border: 1px solid transparent;
        text-decoration: underline;   
    }
    
    .nav > li {
        position: relative;
        display: block;
    }
    
    .container-fluid {
        padding: 0px;
    }

    .container-fluid .main {
        background-color: #ffffff;   
    }

    .page-header {
        padding: 0;    
        margin: 0;
        margin-left: -15px;
        margin-right: -15px;
        border-bottom: 1px solid black;
    }
    
    .page-header h2 {
        padding: 0;
        margin: 10px;
        margin-left: 0px;
    }
    
    .page-header ul {
        margin-top: -40px;
    }

    #playerLabel:hover {
        cursor: pointer;
        background-color: #f5f5f5;
    }
    
    .buttons * {
        display: inline-block;
    }
    
    #message-tool, #wall-card {
        border: 0px;
    }
    
    .card-body {
        padding: 0px;
    }
    
    .input-group-text.oi {
        padding: .55rem .75rem;
        top: 0px;
    }
    
    .btn-light, .btn-light:disabled {
        background-color: #e9ecef;
        border: 1px solid #ced4da;
    }
    
    .btn-light:disabled {
        background-color: #f4f5f7;
        border: 1px solid #e6e9ec;
    }
    
    .btn-light:focus {
      box-shadow: 0 0 0 0rem rgba(0, 0, 0, 0);
    }
</style>

{% endblock %}
